#!/bin/sh

if [ -z $1 ]; then
	logger -s "$0 [netboot]"
	exit 1
fi

	#wangyu add for the test of file length
	size=$(ls -l uImage | awk -F " " '{print $5}')
        echo $size
        if [ $size -gt 2097152 ];then
        	logger -s "wrong size of uImage"
        	exit 1
        fi
        echo "the size of uImage is ok!"
        size=$(ls -l rootfs.squashfs | awk -F " " '{print $5}')
    	echo $size
    	if [ $size -gt 13565952 ];then
      	 	logger -s "wrong size of rootfs"
     		exit 1
  	fi
  	echo "the size of rootfs is ok!"
  	#wangyu add end
sync
/bin/sleep 1
echo "*** Unmounting existing file systems"
/bin/umount /oldroot/dev/pts
/bin/umount /oldroot/proc
#/bin/umount /oldroot/etc
#/bin/umount /oldroot/var
/bin/umount -l /oldroot/

echo "*** Erasing / Copying kernel image to flash (/dev/mtd0)"
#flashcp uImage /dev/mtd0
dd if=uImage of=/dev/mtdblock0
if [ $? -ne 0 ];
then
	logger -s "ERROR: failed to copy kernel image"
	rm -f $FIRMWARE_FILE
        /usr/bin/led-op 1
	exit 3
fi

echo "*** Erasing / Copying rootfs image to flash (/dev/mtd1)"
#flashcp rootfs.squashfs /dev/mtd1
dd if=rootfs.squashfs of=/dev/mtdblock1
if [ $? -ne 0 ];
then
	logger -s "ERROR: failed to copy rootfs image"
	rm -f $FIRMWARE_FILE
        /usr/bin/led-op 1
	exit 4
fi

/bin/sleep 1
echo i > /proc/kes_debug_flag
/sbin/reboot
