#!/usr/bin/haserl
<%in /usr/lib/web/libweb.sh %>
<% response_headers %>
<%
xml_lte=`config_read /config/lte`
xml_lte_acc=`config_getoption "$xml_lte" acc`
xml_lte_apn=`config_getoption "$xml_lte" apn`
xml_lte_mododr=`config_getoption "$xml_lte" mododr`
xml_dhcp=`config_read /config/network/dhcp/dhcpserver`
xml_dhcp_enable=`config_getoption "$xml_dhcp" enable`
xml_dhcp_interface=`config_getoption "$xml_dhcp" interface`
xml_dhcp_leasetime=`config_getoption "$xml_dhcp" leasetime`
xml_dhcp_ipstart=`config_getoption "$xml_dhcp" ipstart`
xml_dhcp_ipend=`config_getoption "$xml_dhcp" ipend`
xml_dhcp_subnet=`config_getoption "$xml_dhcp" subnet`
xml_dhcp_route=`config_getoption "$xml_dhcp" route`
%>
<!--
xml_lte_apn=`/usr/bin/awk -F '=' '/apn/{print $2}' /etc/config/profile.ini`
xml_lte_acc=`/usr/bin/awk -F '=' '/apn/{print $2}' /etc/config/profile.ini`
xml_lte_mododr=`/usr/sbin/ctrl_lte at+mododr? | /bin/grep '+MODODR:' | /usr/bin/awk -F': ' '{print $2}'`
-->
<html>
<head>
<%in page_title.htm %>
<link href="image/style.css" rel="stylesheet" type="text/css">
<script language="JavaScript" src="util.js" type="text/javascript"></script>
<script language="javascript">

function valvalidata_lte()
{
	x1=document.all.mododr; 
	x2=document.all.apn;
	if ( x1.value == "" ){
		alert("The mododr is null.");
		x1.focus();
		return false;
	}
	if ( x2.value == "" ){
		alert("The apn is null.");
		x2.focus();
		return false;
	}	
	if( parseInt(x1.value) < 1 || parseInt(x1.value) > 7){
		alert("The distance of mododr is out of range 1 to 7.");
		x1.focus();
		return false;
	}
	return confirm('Modify the configuration?if continue,ap will be restart to take effect! ');
}

function valvalidata_download()
{
	x3=document.all.filename;
	if ( x3.value == "" ){
		alert("The filename is null.");
		x3.focus();
		return false;
	}
	//return confirm('Download?');
}
var	slog_saveas1="<input type=\"submit\" name=\"SERVLET\" value=\"Open&Download\" onclick=\"return valvalidata_download()\">";
var	b_lansu="<input type=\"submit\" value=\"Apply\" id=\"lsetup\" >";

function Ip() 
{
	  overlayer(); 
}

function lease_check()
{
	var value=document.getElementById("leasetime").value;
	if(!value)
	{
		alert("Leasetime is NULL.\n");
		return false;
	}
	if(isNaN(value))
	{
		alert("Please input a number.\n");
		document.getElementById("leasetime").value="";
		document.getElementById("leasetime").focus();
		return false;
	}
	if(value<0 || value>31536000)
	{
		alert("Invalid leasetime.Please input a number between 0 and 31536000\n");
		document.getElementById("leasetime").value="";
		document.getElementById("leasetime").focus();
		return false;
	}
	return true;
}

function subnet_check()
{
	var value=document.getElementById("subnet").value;

	if(false == common_netmask_check(value))
	{
		document.getElementById("subnet").value="";
		document.getElementById("subnet").focus();
		return false;
	}
	return true;
}

function route_check()
{
	var value=document.getElementById("route").value;

	if(false == common_ip_check(value))
	{
		document.getElementById("route").value="";
		document.getElementById("route").focus();
		return false;
	}
	return true;
}

function ip_check()
{
	var i;
	var ip_start=document.getElementById("ipstart").value;
	var ip_end=document.getElementById("ipend").value;
	var route=document.getElementById("route").value;
	
	if(false==common_ip_check(ip_start))
	{
		document.getElementById("ipstart").value="";
		document.getElementById("ipstart").focus();
		return false;
	}

	if(false==common_ip_check(ip_end))
	{
		document.getElementById("ipend").value="";
		document.getElementById("ipend").focus();
		return false;
	}
	
	var start=ip_start.split(".");
	var end=ip_end.split(".");
	var route=route.split(".");
	
	var s_ip=parseInt(start[0])*Math.pow(256,3)+parseInt(start[1])*Math.pow(256,2)+parseInt(start[2])*Math.pow(256,1)+parseInt(start[3]);
	var rt=parseInt(route[0])*Math.pow(256,3)+parseInt(route[1])*Math.pow(256,2)+parseInt(route[2])*Math.pow(256,1)+parseInt(route[3]);
	var e_ip=parseInt(end[0])*Math.pow(256,3)+parseInt(end[1])*Math.pow(256,2)+parseInt(end[2])*Math.pow(256,1)+parseInt(end[3]);

	if(s_ip>e_ip)
	{
		alert("Ip_start exceeds the ip_end.\n");
		return false;
	}
	
	if(rt>=s_ip && rt<=e_ip)
	{
		alert("Gateway ip is included in ip_range.\n");
		return false;
	}
	
	return true;
}

function check()
{
	if(document.getElementsByName("dhcpenable")[0].checked==true)
		return lease_check() && subnet_check() && route_check() && ip_check();
	return true;
}

</script>
</head>
<body>
<%in page_header.htm %>
<%in menu_extend3.htm %>
<div align="center">
<table bgcolor="#f4f9fd" border="0"  cellpadding="0" cellspacing="0" width="774" >
<tr>
			<td  height="25">
			</td>
</tr>

<tr>
<td align="center"  bordercolor="#f4f9fd">
<form method="post" action="<%= $action_cgi %>">
<div align="center" >
<table bgcolor="#ffffff" align="center"  bordercolor="#90b5dd"  border="1" cellpadding="0" cellspacing="0" width="650">

<tr>
<td colspan="2" align="left" width="100%"  height="22" bgcolor="#456f95" bordercolor="#456f95"><b>LTE Config</b></td>
</tr>

<tr>
			<td colspan="2" height="10">
			</td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">wan0 IP:&nbsp;</td>
<td   bordercolor="#ffffff"><% /sbin/ifconfig wan0 | /bin/grep -o -i -e "inet addr:[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}\.[0-9]\{1,3\}" | /usr/bin/cut -d: -f2 %></td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">SoftwareVersion:&nbsp;</td>
<td   bordercolor="#ffffff"><% /usr/sbin/ctrl_lte AT+LCTSW | /bin/grep 'SoftwareVersion:' | /usr/bin/awk -F': ' '{print $2}' %></td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">InnerVersion:&nbsp;</td>
<td   bordercolor="#ffffff"><% /usr/sbin/ctrl_lte AT+LCTSW | /bin/grep 'InnerVersion:' | /usr/bin/awk -F': ' '{print $2}' %></td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">CSQ:&nbsp;</td>
<td   bordercolor="#ffffff"><% /usr/sbin/ctrl_lte at+csq | /bin/grep '+csq:' | /usr/bin/awk -F': ' '{print $2}' %></td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">PSRAT:&nbsp;</td>
<td   bordercolor="#ffffff"><% /usr/sbin/ctrl_lte at+PSRAT | /bin/grep '+PSRAT:' | /usr/bin/awk -F': ' '{print $2}' %></td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">MODODR:&nbsp;</td>
<td bordercolor="#ffffff"><input type="text" name="mododr" value="<%= "$xml_lte_mododr" %>"></td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">APN:&nbsp;</td>
<td bordercolor="#ffffff"><input type="text" name="apn" value="<%= "$xml_lte_apn" %>"></td>
</tr>

<tr>
<td align="right" height="10"  bordercolor="#ffffff">ACC:&nbsp;</td>
<td bordercolor="#ffffff"><input type="text" name="acc" value="<%= "$xml_lte_acc" %>">seconds</td>
</tr>

</tr>
</table>
<table  align="center"  border="0" cellpadding="0" cellspacing="0" width="650">
<tr>
			<td colspan="2" height="5">
			</td>
<tr>
<td align="center" ><input type="submit" value="Apply_Setup" name="SERVLET" onclick="return valvalidata_lte()"></td>
</tr>
</table>
</div>
</form>
</td>
</tr>

<tr>
<td align="center"  bordercolor="#f4f9fd">
<form method="post" action="<%= $action_cgi %>">
<div align="center" >
<table bgcolor="#ffffff" align="center"  bordercolor="#90b5dd"  border="1" cellpadding="0" cellspacing="0" width="650">
		<tr>
		<td colspan="2" align="left" width="100%"  height="22" bgcolor="#456f95" bordercolor="#456f95"><b>Storage Contents</b></td>
		</tr>
		<tr>
		<td colspan="2" height="10">
		</td>
		</tr>

		<tr>
		<td width="200" bordercolor="#ffffff"></td><td width="450"   bordercolor="#ffffff"><pre><% /bin/ls -l /tmp/udisk %></pre></td>
		</tr>

		<tr>
		<td colspan="2" height="10">
		</td>
		</tr>							
</table>

<table bgcolor="#ffffff" align="center"  bordercolor="#90b5dd"  border="1" cellpadding="0" cellspacing="0" width="650">

	<tr>
	<td colspan="2" align="left" width="100%"  height="22" bgcolor="#456f95" bordercolor="#456f95"><b>Open&Download</b></td>
	</tr>

	<tr>
	<td colspan="2" height="20">
	</td>
	</tr>

	<tr>
	<td colspan="2" align="center" height="24"  bordercolor="#ffffff"><label>

	<b>Input a file name:</b>&nbsp;<input type="text" name="filename" value="<%= "$filename" %>">&nbsp;
	<script language="javascript">replace(slog_saveas1)</script>
	</label></td>
	</tr>

	</label></td>
	</tr>

	<tr>
	<td colspan="2" height="20">
	</td>
	</tr>

</table>

			
</div>
</form>
</td>
</tr>

<tr>
<td  height="25">
</td>
</tr>

<tr>
<td align="center"  bordercolor="#f4f9fd">
<form method="post" action="<%= $action_cgi %>" onsubmit="return check() && Ip()">
	<div align="center">
		<table bgcolor="#ffffff" align="center"  bordercolor="#90b5dd"  border="1" cellpadding="0" cellspacing="0" width="650">
			<tr>
			<td width="100%" align="left" colspan="2" height="22" bgcolor="#456f95" bordercolor="#456f95"><b>dhcp_server</b></td>
			</tr>

			<tr>
			<td colspan="2" height="10">
			</td>
			</tr>

			<tr>
			<td align="left" height="24" bordercolor="#ffffff">dhcp_enablestate&nbsp;</td>
			<td align="left" bordercolor="#ffffff">
				<input type="radio" <% webui_radiobutton_check "$xml_dhcp_enable" "yes" %> name="dhcpenable" value="yes"  />Enable
				&nbsp;&nbsp; <input type="radio" <% webui_radiobutton_check "$xml_dhcp_enable" "no" %> name="dhcpenable" value="no" />Disable
			</td> 
			</tr>

			<tr >
				<td align="left" height="20" bordercolor="#ffffff">DHCP Rent Period
				</td><td align="left" bordercolor="#ffffff"><input type="text" name="leasetime" id="leasetime" value="<%= "$xml_dhcp_leasetime" %>">seconds</td>
			</tr>

			<tr >
				<td align="left" height="20" bordercolor="#ffffff">Subnet Mask&nbsp;
				</td><td align="left" bordercolor="#ffffff"><input type="text" name="subnet" id="subnet" value="<%= "$xml_dhcp_subnet" %>" ></td>
			</tr>

			<tr >
				<td align="left" height="20" bordercolor="#ffffff">Gateway&nbsp;
				</td><td align="left" bordercolor="#ffffff"><input type="text" name="route" id="route" value="<%= "$xml_dhcp_route" %>" ></td>
			</tr>

			<tr >
				<td align="left" height="20" bordercolor="#ffffff">IP Address Range&nbsp;
				</td><td align="left" bordercolor="#ffffff"><input type="text" name="ipstart" id="ipstart" value="<%= "$xml_dhcp_ipstart" %>" >-<input type="text" name="ipend" id="ipend" value="<%= "$xml_dhcp_ipend" %>" ></td>
			</tr>

			<tr>
				<td colspan="2" height="10">
				</td>
			</tr>

			<tr>
				<td width="100%" align="left" colspan="2" height="22" bgcolor="#456f95" bordercolor="#456f95"><b>Users Lease Infomation</b></td>
			</tr>

			<tr>
				<td colspan="2" height="10">
				</td>
			</tr>

			<tr>
				<td colspan="2" bordercolor="#ffffff"><label>
				<textarea name="messages" cols="100" rows="10"><%
				if [ -f "/tmp/udhcpd.leases" ]; then
				/usr/bin/dumpleases -f /tmp/udhcpd.leases
				fi
				%></textarea></label>
				</td>
			</tr>

		</table>
		<table  align="center"  border="0" cellpadding="0" cellspacing="0" width="650">	
			<tr>
				<td align="center" height="40" valign="middle" colspan="2" ><script language="javascript" >replace(b_lansu)</script>&nbsp;</td>
			</tr>
		</table>
	</div>
	<input type="hidden" value="DHCP Setup" name="SERVLET">
</form>
</td>
</tr>

<tr>
<td  height="25">
</td>
</tr>
</table>


</table>
</div>
<%in page_footer.htm %>
</body>
</html>

