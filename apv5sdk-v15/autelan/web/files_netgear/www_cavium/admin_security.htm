#!/usr/bin/haserl
<%in /usr/lib/web/libweb.sh %>
<% session_validate %>
<% response_headers %>

<%
xml_netrule=`config_read /config/netsecury/netfilter`
xml_netrule_count=`config_getoption "$xml_netrule" icount`
xml_netrule_idefault=`config_getoption "$xml_netrule" inputdefault`
for innum in `seq $xml_netrule_count`
do
	eval LINE$innum=\"`config_getoption "$xml_netrule" inrule$innum 2>/dev/null`\"
done

  	
xml_session=`config_read /config/session`
xml_session_lang=`config_getoption "$xml_session" language`
%>

<html>
<head>
<%in page_title.htm %>
<link href="image/style.css" rel="stylesheet" type="text/css">
<% include_js access_control.js %>
<script language="JavaScript" src="util.js" type="text/javascript"></script>
<script language="javascript">
	var flag="<%= $xml_session_lang %>";
	init_mmenu(flag);
	init_acmenu(flag);
	init_adminsec(flag);
var array1=["<%= $LINE1 %>","<%= $LINE2 %>","<%= $LINE3 %>","<%= $LINE4 %>","<%= $LINE5 %>","<%= $LINE6 %>","<%= $LINE7 %>","<%= $LINE8 %>","<%= $LINE9 %>","<%= $LINE10 %>","<%= $LINE11 %>","<%= $LINE12 %>","<%= $LINE13 %>","<%= $LINE14 %>","<%= $LINE15 %>","<%= $LINE16 %>","<%= $LINE17 %>","<%= $LINE18 %>","<%= $LINE19 %>","<%= $LINE20 %>"];
function loadtable()
{
	document.all.idpolicy.value="<%= $xml_netrule_idefault %>";
  var tl=document.getElementById("tableList"); 
  var count=parseInt(document.all.rulecount.value);
  for(i=1;i<=count;i++)   
  {
  	var rule="rule"+i;
		document.getElementById(rule).value=array1[i-1];
  	str=array1[i-1].split("%"); 
	  for(j=0;j<5;j++)   
	  { 
	  	 if(j == 4) 
	  	 {
	  	 	  var obj1 = document.createElement("INPUT");
				  obj1.type = "button";
				  obj1.name = "del"+i;
				  obj1.id = "del"+i; 
				  obj1.value = "del";
				  obj1.onclick = function(){return delrule(this);}
	  	 	  tl.rows[i].cells[j].appendChild(obj1);
	  	 }
	  	 else
	  	 {   
	      	tl.rows[i].cells[j].innerText=str[j];
	     }   
	  }   
  }    
}  

function add()
{
	
  var tl=document.getElementById("tableList"); 
  var count=parseInt(document.all.rulecount.value)+1;
  if(count>20)
  {
  	alert("您最多配20条规则");
  	return false;
  }
  var at1=document.all.ifin.value;
  var at2=document.all.macaddr.value;
  var at3=document.all.ipaddr.value;
  var at4=document.all.decision.value;
  if(at1=="")
    at1="-";
  if(at2=="")
    at2="-";
  if(at3=="")
    at3="-";
  if(at4=="")
    at4="-"; 
  var arr=[at1,at2,at3,at4];
	  for(j=0;j<5;j++)   
	  { 
	  	 if(j == 4) 
	  	 {
	  	 	  var obj1 = document.createElement("INPUT");
				  obj1.type = "button";
				  obj1.name = "del"+count;
				  obj1.id = "del"+count; 
				  obj1.value = "del";
				  obj1.onclick = function(){return delrule(this);}
	  	 	  tl.rows[count].cells[j].appendChild(obj1);
	  	 }
	  	 else
	  	 {   
	      tl.rows[count].cells[j].innerText=arr[j];
	     }   
	  }
	  document.all.rulecount.value = count;  
	  document.all.rulecount1.value = count; 
	  var crule="rule"+count;
	  document.getElementById(crule).value=arr[0]+"%"+arr[1]+"%"+arr[2]+"%"+arr[3];
}

function getParent(myElement,myTagName)
{
   
	if(myElement.tagName == "BODY")
	{
	    
	    return false;
	}
	
	if(myElement.tagName == myTagName)
	{
	    return myElement;
	}
	else
	{
	    return getParent(myElement.parentElement,myTagName);
	}
}

function delrule(btobject)
{
   var str1=btobject.name.split("l");
   var myTr = getParent(btobject,"TR"); 
	 if(myTr != false)
	 {
		   myTr.parentElement.removeChild(myTr);	   
	 }  

   var trHeader = tableList.insertRow();
   for(var i=1;i<=5;i++)
   {
		   var tdHeader = trHeader.insertCell();
		   tdHeader.borderColor = "#1efffe";
		   tdHeader.align = "center";
   }
   
	 var tmp=parseInt(str1[1])+1;
	 var count=parseInt(document.all.rulecount.value);   
	 for(var p=tmp;p<=count;p++)
	 {
			var str = "del"+p;
			var strt = p-1;
			var tmprule="rule"+p;
			var assignrule="rule"+strt;
		  document.getElementById(str).name = "del"+strt;
			document.getElementById(str).id = "del"+strt;
			document.getElementById(assignrule).value=document.getElementById(tmprule).value;
	 }
	 document.all.rulecount.value = count-1;
	 document.all.rulecount1.value = count-1;


}

function mpolicy()
{
	if(document.all.idpolicy.value == "")
	  document.all.defpolicy.value="ACCEPT";
	else
	  document.all.defpolicy.value=document.all.idpolicy.value;	
        overlayer();	
}

</script>
</head>
<body onload="loadtable()">
<%in overlayer.htm %>
<%in page_header.htm %>
<%in menu_accontrol.htm %>
<div align="center">
<table bgcolor="#f4f9fd" border="0"  cellpadding="0" cellspacing="0" width="774" >
<tr>
			<td  height="25">
			</td>
</tr>

<tr>
<td align="center"  bordercolor="#f4f9fd">
<div align="center">
<table bgcolor="#ffffff" align="center"  bordercolor="#90b5dd"  border="1" cellpadding="0" cellspacing="0" width="650">
			<tr>
		<td bordercolor="#d9d9d9">						
       <table  bgcolor="#ffffff" align="center"    border="0" cellpadding="0" cellspacing="0" width="650">
	     <tr>
			<td width="100%" align="left" colspan="2"   height="22" bgcolor="#d9d9d9" bordercolor="#d9d9d9"><b><script language="javascript">replace(adminsec_title)</script></b></td>
			</tr>
			
			<tr>
			<td  height="10" colspan="2">
			</td>
			</tr>
			
			<tr>
					<td align="right" height="28" bordercolor="#ffffff" width="220"><script language="javascript">replace(adminsec_dpolicy)</script>&nbsp;
					</td><td align="left"  bordercolor="#ffffff" width="430"><select name="idpolicy" >
					<option  value="ACCEPT" >Allow</option>
					<option  value="DROP" >prevent</option>
					</select>
					</td>
			</tr>
			
			<tr>
				<td  height="10" colspan="2">
				</td>
	      </tr>
	      
	      <tr>
			<td width="100%" align="left" colspan="2"  height="22" bgcolor="#d9d9d9" bordercolor="#d9d9d9"><b><script language="javascript">replace(adminsec_addrule)</script></b></td>
			</tr>
			
	     <tr>
				<td  height="10" colspan="2">
				</td>
	      </tr>
			
			<tr>
			<td align="right"  height="28" bordercolor="#ffffff" >&nbsp;&nbsp;&nbsp;&nbsp;<script language="javascript">replace(adminsec_ifin)</script>&nbsp;
					</td><td align="left"  bordercolor="#ffffff"><select name="ifin" >
					<option  value="" >none</option>
					<option  value="ath0" >vap1</option>
					<option  value="ath1">vap2</option>
					<option  value="ath2">vap3</option>
					<option  value="ath3">vap4</option>
					<option  value="ath4">vap5</option>
					<option  value="ath5">vap6</option>
					<option  value="ath6">vap7</option>
					<option  value="eth0">eth0</option>
					<option  value="eth1">eth1</option>
					<option  value="! ath0" >!vap1</option>
					<option  value="! ath1">!vap2</option>
					<option  value="! ath2">!vap3</option>
					<option  value="! ath3">!vap4</option>
					<option  value="! ath4">!vap5</option>
					<option  value="! ath5">!vap6</option>
					<option  value="! ath6">!vap7</option>
					<option  value="! eth0">!eth0</option>
					<option  value="! eth1">!eth1</option>
					</select>
					</td>
		  </tr>
			
			<tr>
			<td align="right" height="28" bordercolor="#ffffff"><script language="javascript">replace(adminsec_smac)</script>&nbsp;
			</td><td align="left"  bordercolor="#ffffff"><input type="text" name="macaddr"  ></td>
		  </tr>
		  
		  <tr>
			<td align="right" height="28" bordercolor="#ffffff">&nbsp;<script language="javascript">replace(adminsec_sip)</script>&nbsp;
			</td><td align="left"  bordercolor="#ffffff"><input type="text" name="ipaddr"  ></td>
		  </tr>
			
			<tr>
					<td align="right"  height="28" bordercolor="#ffffff" ><script language="javascript">replace(adminsec_cpolicy)</script>&nbsp;
					</td><td align="left"  bordercolor="#ffffff">
					<select name="decision" >
					<option  value="ACCEPT" >Allow</option>
					<option  value="DROP">prevent</option>
					</select>
					</td>
			</tr>
			
			<tr>
					<td align="right"   height="28" bordercolor="#ffffff" ></td><td align="right"  bordercolor="#ffffff">&nbsp;<script language="javascript">replace(adminsec_add)</script>&nbsp;</td> 
			</tr>
			
			<tr>
				<td  height="10" colspan="2">
				</td>
	      </tr>
	      
	      <tr>
			<td width="100%" align="left" colspan="2"   height="22" bgcolor="#d9d9d9" bordercolor="#d9d9d9"><b><script language="javascript">replace(adminsec_hrule)</script></b></td>
			</tr>
			</table>
			<input type="hidden" value="<%= $xml_netrule_count %>" name="rulecount1" >
		    <table name="tableList" id="tableList"  align="center"  border="1" cellpadding="0" cellspacing="0" width="650">	      
	      <tr >
				<td  align="center" width="50"  bordercolor="#d9d9d9">Input</td>						
				<td  align="center" width="200"  bordercolor="#d9d9d9">MAC/mask</td>								
				<td  align="center" width="200"  bordercolor="#d9d9d9">IP/mask</td>
				<td  align="center" width="50"  bordercolor="#d9d9d9">policy</td>
				<td  align="center" width="150"  bordercolor="#d9d9d9">\</td>
				</tr>
				
				<tr id="t1">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>	
				</tr>
				<tr id="t2">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t3">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t4">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t5">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t6">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t7">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t8">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t9">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t10">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t11">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t12">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t13">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t14">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t15">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t16">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t17">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t18">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t19">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				<tr id="t20">
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>				
				<td  align="center"   bordercolor="#d9d9d9"></td>
				</tr>
				</table>
			</td>
			</tr>	
		</table>
<form name="form2" method="post" action="<%= $action_cgi %>" onsubmit="return mpolicy()">  
		<table  align="center"  border="0" cellpadding="0" cellspacing="0" width="650">	
			<tr>
			  <td align="center" height="40" valign="middle" colspan="2" ><script language="javascript">replace(adminsec_apply)</script>&nbsp;</td>
			</tr>
			<tr>
        <td align="right"   colspan="2"><script language="javascript">replace(adminsec_help)</script></td>
			</tr>
		</table>
<input type="hidden" value="Adminap Setup" name="SERVLET">
<input type="hidden" value="old" name="updateflag" >
<input type="hidden" value="ACCEPT" name="defpolicy" >
<input type="hidden" value="<%= $xml_netrule_count %>" name="rulecount" >
<input type="hidden" value="" name="rule1" id="rule1">
<input type="hidden" value="" name="rule2" id="rule2">
<input type="hidden" value="" name="rule3" id="rule3">
<input type="hidden" value="" name="rule4" id="rule4">
<input type="hidden" value="" name="rule5" id="rule5">
<input type="hidden" value="" name="rule6" id="rule6">
<input type="hidden" value="" name="rule7" id="rule7">
<input type="hidden" value="" name="rule8" id="rule8">
<input type="hidden" value="" name="rule9" id="rule9">
<input type="hidden" value="" name="rule10" id="rule10">
<input type="hidden" value="" name="rule11" id="rule11">
<input type="hidden" value="" name="rule12" id="rule12">
<input type="hidden" value="" name="rule13" id="rule13">
<input type="hidden" value="" name="rule14" id="rule14">
<input type="hidden" value="" name="rule15" id="rule15">
<input type="hidden" value="" name="rule16" id="rule16">
<input type="hidden" value="" name="rule17" id="rule17">
<input type="hidden" value="" name="rule18" id="rule18">
<input type="hidden" value="" name="rule19" id="rule19">
<input type="hidden" value="" name="rule20" id="rule20">
</form>
</div>
</td>
</tr>

<tr>
			<td  height="25">
			</td>
</tr>
</table>
</div>
<%in page_footer.htm %>
</body>
</html>

